name: Dev Docker Build

on:
  workflow_dispatch:

  push:
    branches:
      - main
    paths:
      - ui/**
      - core/**
      - Dockerfile
      - .github/workflows/action-docker.yml
      - .github/workflows/action-docker-combine.yml

permissions:
  contents: write
  packages: write

env:
  title: redstash
  dockerfile: Dockerfile
  version_tag: v1.0.0
  source_branch: main

jobs:
  build-amd64:
    uses: ./.github/workflows/action-docker.yml
    with:
      title: ${{env.title}}
      dockerfile: ${{env.dockerfile}}
      version_tag: ${{env.version_tag}}
      source_branch: ${{env.source_branch}}
      platform: linux/amd64
      arch_suffix: amd64
      machine: ubuntu-latest

  build-arm64:
    uses: ./.github/workflows/action-docker.yml
    with:
      title: ${{env.title}}
      dockerfile: ${{env.dockerfile}}
      version_tag: ${{env.version_tag}}
      source_branch: ${{env.source_branch}}
      platform: linux/arm64
      arch_suffix: arm64
      machine: ubuntu-24.04-arm

  combine:
    uses: ./.github/workflows/action-docker-combine.yml
    needs: [ build-amd64, build-arm64 ]
    with:
      title: ${{env.title}}
      version_tag: ${{env.version_tag}}
      is_latest: true
      build_amd64: true
      build_arm64: true
